<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders Management - Omoola Admin</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <h2>Omoola Admin</h2>
            <ul class="admin-menu">
                <li><a href="index.html">
                    <span>üìä</span> Dashboard
                </a></li>
                <li><a href="products.html">
                    <span>üì¶</span> Products
                </a></li>
                <li><a href="categories.html">
                    <span>üè∑Ô∏è</span> Categories
                </a></li>
                <li><a href="orders.html" class="active">
                    <span>üõí</span> Orders
                </a></li>
                <li><a href="users.html">
                    <span>üë•</span> Users
                </a></li>
                <li><a href="../index.html">
                    <span>üè†</span> Back to Store
                </a></li>
                <li><a href="#" onclick="handleLogout()">
                    <span>üö™</span> Logout
                </a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <div class="admin-header">
                <h1>Orders Management</h1>
                <div>
                    <select class="form-control" id="statusFilter" style="display: inline-block; width: auto;">
                        <option value="">All Orders</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>

            <!-- Orders Table -->
            <div style="background: white; padding: 2rem; border-radius: var(--radius-lg);">
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Order Details</h3>
                <button class="modal-close" onclick="closeOrderModal()">&times;</button>
            </div>
            <div id="orderDetails"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="../js/config.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        let orders = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            document.getElementById('statusFilter').addEventListener('change', filterOrders);
        });
        
        async function loadOrders() {
            try {
                if (typeof firebase !== 'undefined' && db) {
                    const snapshot = await db.collection('orders').get();
                    orders = [];
                    snapshot.forEach(doc => {
                        orders.push({ id: doc.id, ...doc.data() });
                    });
                    displayOrders(orders);
                } else {
                    loadDemoOrders();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                loadDemoOrders();
            }
        }
        
        function loadDemoOrders() {
            orders = [
                { id: 'ORD001', customerInfo: { name: 'John Doe', email: 'john@example.com', phone: '+234 123 456 7890' }, orderDate: '2024-11-15T10:30:00', items: [{name: 'Paracetamol 500mg', quantity: 2, price: 1500}], total: 5000, status: 'pending' },
                { id: 'ORD002', customerInfo: { name: 'Jane Smith', email: 'jane@example.com', phone: '+234 098 765 4321' }, orderDate: '2024-11-14T15:20:00', items: [{name: 'Vitamin C Tablets', quantity: 1, price: 3500}], total: 8500, status: 'processing' },
                { id: 'ORD003', customerInfo: { name: 'Mike Johnson', email: 'mike@example.com', phone: '+234 111 222 3333' }, orderDate: '2024-11-14T09:15:00', items: [{name: 'Hand Sanitizer 500ml', quantity: 3, price: 2000}], total: 22000, status: 'completed' }
            ];
            displayOrders(orders);
        }
        
        function displayOrders(ordersToDisplay) {
            const tbody = document.getElementById('ordersTable');
            
            if (ordersToDisplay.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            ordersToDisplay.forEach(order => {
                const tr = document.createElement('tr');
                const statusColors = {
                    'pending': 'var(--warning)',
                    'processing': 'var(--primary-color)',
                    'completed': 'var(--success)',
                    'cancelled': 'var(--danger)'
                };
                
                tr.innerHTML = `
                    <td><strong>${order.id}</strong></td>
                    <td>${order.customerInfo?.name || 'N/A'}</td>
                    <td>${new Date(order.orderDate).toLocaleDateString()}</td>
                    <td>${order.items?.length || 0} item(s)</td>
                    <td>‚Ç¶${(order.total || 0).toLocaleString()}</td>
                    <td><span style="color: ${statusColors[order.status]}; font-weight: 600;">${order.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewOrderDetails('${order.id}')">View</button>
                        <select class="form-control" style="display: inline-block; width: auto; margin-left: 0.5rem;" onchange="updateOrderStatus('${order.id}', this.value)">
                            <option value="">Change Status</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function filterOrders() {
            const status = document.getElementById('statusFilter').value;
            if (status) {
                const filtered = orders.filter(o => o.status === status);
                displayOrders(filtered);
            } else {
                displayOrders(orders);
            }
        }
        
        function viewOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const details = document.getElementById('orderDetails');
            details.innerHTML = `
                <div style="padding: 1rem;">
                    <h4>Order ${order.id}</h4>
                    <p><strong>Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                    <p><strong>Status:</strong> ${order.status}</p>
                    
                    <h4 style="margin-top: 1.5rem;">Customer Information</h4>
                    <p><strong>Name:</strong> ${order.customerInfo?.name || 'N/A'}</p>
                    <p><strong>Email:</strong> ${order.customerInfo?.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${order.customerInfo?.phone || 'N/A'}</p>
                    <p><strong>Address:</strong> ${order.customerInfo?.address || 'N/A'}</p>
                    
                    <h4 style="margin-top: 1.5rem;">Order Items</h4>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(order.items || []).map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>‚Ç¶${item.price.toLocaleString()}</td>
                                        <td>‚Ç¶${(item.price * item.quantity).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <p><strong>Subtotal:</strong> ‚Ç¶${(order.subtotal || 0).toLocaleString()}</p>
                        <p><strong>Shipping:</strong> ‚Ç¶${(order.shipping || 0).toLocaleString()}</p>
                        <p><strong>Tax:</strong> ‚Ç¶${(order.tax || 0).toLocaleString()}</p>
                        <h3><strong>Total:</strong> ‚Ç¶${(order.total || 0).toLocaleString()}</h3>
                    </div>
                </div>
            `;
            
            document.getElementById('orderModal').classList.add('active');
        }
        
        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }
        
        async function updateOrderStatus(orderId, newStatus) {
            if (!newStatus) return;
            
            try {
                if (typeof firebase !== 'undefined' && db) {
                    await db.collection('orders').doc(orderId).update({ status: newStatus });
                    showNotification('Order status updated!', 'success');
                } else {
                    const order = orders.find(o => o.id === orderId);
                    if (order) order.status = newStatus;
                    showNotification('Order status updated! (Demo Mode)', 'success');
                }
                loadOrders();
            } catch (error) {
                console.error('Error updating order:', error);
                showNotification('Error updating order status', 'danger');
            }
        }
        
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('orderModal');
            if (e.target === modal) {
                closeOrderModal();
            }
        });
    </script>
</body>
</html>
